# Push Notifications - Testing Guide

This document explains how push notifications work in GetSpot and how to test them.

**Last Updated:** 2025-10-13

---

## Overview

GetSpot uses Firebase Cloud Messaging (FCM) to send push notifications to users. Notifications are triggered by Cloud Functions in response to specific events like:
- New event created (`new_event`)
- Join request approved (`join_approved`)
- Join request denied (`join_denied`)
- Event cancelled (`event_cancelled`)
- Waitlist promoted (`waitlist_promoted`)
- Event reminder 24h before event (`event_reminder`)

---

## Prerequisites for Receiving Notifications

### 1. FCM Token Must Be Registered

When a user signs into the app, the `NotificationService` automatically:
1. Requests notification permission from the device (iOS/Android)
2. Retrieves the FCM token from Firebase
3. Calls the `updateFcmToken` Cloud Function to save it
4. Function saves token to `/users/{userId}.fcmTokens` array in Firestore

**Check if your token is registered:**
```
Firebase Console → Firestore → users → [your-user-id]
```

Look for the `fcmTokens` field - it should contain an array with at least one token string.

**If fcmTokens field is missing:**
1. Check app logs for "FCM Token:" - verify token was retrieved
2. Check app logs for "Successfully updated FCM token" - verify function call succeeded
3. Check Firebase Console → Functions → Logs for `updateFcmToken` errors
4. Ensure Cloud Function is deployed: `firebase deploy --only functions:updateFcmToken`
5. Force refresh by restarting app while signed in

### 2. Notifications Must Be Enabled

- **iOS:** Settings → GetSpot → Notifications → Allow Notifications (ON)
- **Android:** Settings → Apps → GetSpot → Notifications (ON)

### 3. App Must Be Properly Configured

- `GoogleService-Info.plist` (iOS) must exist (auto-generated by CI/CD)
- `google-services.json` (Android) must exist
- FCM is initialized in `lib/main.dart:51`
- `NotificationService` is initialized in `lib/main.dart:251`

---

## Why You Might Not See Notifications

### Common Issues

1. **FCM Token Not Saved**
   - Check Firestore → `/users/{userId}` → verify `fcmTokens` array exists
   - Reinstall the app to trigger FCM token registration
   - Check app logs for "FCM token registered" message

2. **Notifications Disabled on Device**
   - Go to device Settings → Apps → GetSpot → Notifications
   - Ensure notifications are enabled

3. **App in Foreground** (iOS only)
   - iOS doesn't show notification banners when app is in foreground by default
   - Notification is still received but only logged to console
   - Put app in background to see banner

4. **Invalid/Expired FCM Token**
   - FCM tokens can expire or become invalid
   - The `cleanupInvalidTokens` function removes invalid tokens
   - Reinstall app to generate new token

5. **Cloud Function Not Triggered**
   - Check Firebase Console → Functions → Logs
   - Look for execution logs for functions like `notifyOnNewEvent`, `manageJoinRequest`
   - Verify the triggering action completed successfully

---

## How to Test Notifications

### Test 1: New Event Created

**Trigger:** Create a new event as a group admin

**Steps:**
1. Sign in as User A (admin of a group)
2. Sign in as User B (member of same group) on a different device
3. As User A, create a new event in the group
4. User B should receive notification: "New Event: [Group Name]"

**Expected behavior:**
- User B sees notification banner (if app in background)
- Tapping notification navigates to EventDetailsScreen
- Check logs in User B's app for "Handling notification navigation"

**Troubleshooting:**
- Check Firebase Console → Functions → `notifyOnNewEvent` logs
- Verify event document was created in `/events` collection
- Verify User B has FCM token in Firestore

---

### Test 2: Join Request Approved

**Trigger:** Admin approves a user's join request

**Steps:**
1. Sign in as User A (not in any group)
2. Request to join a group (enter group code)
3. Sign in as User B (admin of that group) on different device
4. As User B, approve User A's join request
5. User A should receive notification: "Join Request Approved"

**Expected behavior:**
- User A sees notification
- Tapping notification navigates to GroupDetailsScreen
- User A can now see group events

**Troubleshooting:**
- Check Firebase Console → Functions → `manageJoinRequest` logs
- Verify join request status changed from "pending" to "approved"
- Verify User A's membership document created in `/groups/{groupId}/members/{userId}`

---

### Test 3: Event Cancelled

**Trigger:** Admin cancels an event

**Steps:**
1. Sign in as User A (admin)
2. Sign in as User B (member registered for event) on different device
3. As User A, cancel the event
4. User B should receive notification: "Event Cancelled"

**Expected behavior:**
- User B sees notification
- Tapping notification navigates to Event DetailsScreen (showing "Event Cancelled")
- User B's wallet refunded automatically

**Troubleshooting:**
- Check Firebase Console → Functions → `cancelEvent` logs
- Verify event status changed to "cancelled"
- Verify participants received refunds

---

### Test 4: Waitlist Promoted

**Trigger:** Spot opens up and waitlisted user is promoted

**Steps:**
1. Create event with capacity 1
2. Have User A register (gets confirmed)
3. Have User B register (gets waitlisted)
4. Have User A withdraw from event
5. User B should receive notification: "You've Been Promoted!"

**Expected behavior:**
- User B's status changes from "waitlisted" to "confirmed"
- User B sees notification
- Tapping notification navigates to EventDetailsScreen

**Troubleshooting:**
- Check Firebase Console → Functions → `processWaitlist` logs
- Verify User B's participant status is "confirmed"
- Check that withdrawal triggered the waitlist processing

---

### Test 5: Event Reminder

**Trigger:** Scheduled function runs 24h before event

**Setup:** This is more complex to test because it's time-based.

**Option A: Manually trigger the function**
```bash
cd functions
npm run build
firebase functions:shell

# In the shell:
sendEventReminders()
```

**Option B: Create event 24h in future**
1. Create event exactly 24 hours from now
2. Wait for scheduled function to run (runs every hour)
3. Check logs in Firebase Console → Functions → `sendEventReminders`

**Expected behavior:**
- All confirmed participants receive "Event Reminder" notification
- Tapping navigates to EventDetailsScreen

---

## Testing Navigation from Notifications

After implementing notification navigation in `lib/main.dart`, test that tapping notifications correctly navigates:

1. **When app is in foreground:**
   - Notification data is passed to `_handleNotificationNavigation`
   - Should navigate immediately

2. **When app is in background:**
   - Tapping notification brings app to foreground
   - `onMessageOpenedApp` handler triggers navigation

3. **When app is terminated:**
   - Tapping notification opens app
   - `getInitialMessage` retrieves notification data
   - Should navigate after app initializes

**Check logs for:**
```
[AuthWrapper] Handling notification navigation: {type: new_event, eventId: abc123, groupId: xyz789}
[AuthWrapper] Navigating to event: abc123
```

---

## Debugging Notifications

### Enable Verbose Logging

Add this to check notification flow:

```dart
// In NotificationService
FirebaseMessaging.onMessage.listen((RemoteMessage message) {
  developer.log('Foreground message received', name: 'NotificationService');
  developer.log('Title: ${message.notification?.title}', name: 'NotificationService');
  developer.log('Body: ${message.notification?.body}', name: 'NotificationService');
  developer.log('Data: ${message.data}', name: 'NotificationService');
  // ... rest of handler
});
```

### Check Firebase Console

1. **Functions Logs:**
   - Firebase Console → Functions → Logs
   - Filter by function name (e.g., `notifyOnNewEvent`)
   - Look for "Sending notification to X users"

2. **Firestore:**
   - Check `/users/{userId}.fcmTokens` array
   - Check event/group documents are created correctly

3. **Cloud Messaging:**
   - Firebase Console → Cloud Messaging
   - Can send test messages to specific tokens

---

## Manual Testing with Firebase Console

You can send test notifications directly:

1. Go to Firebase Console → Cloud Messaging
2. Click "Send your first message"
3. Enter notification title and text
4. Click "Send test message"
5. Paste your FCM token (from Firestore)
6. Send

**Note:** This won't include the custom `data` payload, so navigation won't work. It's only useful for testing if FCM delivery works.

---

## Known Limitations

1. **iOS Foreground Notifications:**
   - iOS doesn't show banner when app is in foreground
   - Notification still logged and can trigger in-app UI

2. **Token Expiration:**
   - FCM tokens can expire
   - App automatically refreshes and updates tokens

3. **Notification Permissions:**
   - User must grant permission on first launch
   - If denied, must manually enable in device settings

---

## Related Files

- `lib/services/notification_service.dart` - FCM setup, token registration, and notification handlers
- `lib/main.dart:104-221` - Notification navigation logic in AuthWrapper
- `firestore.rules:13-18` - Security rules allowing FCM token updates
- `functions/src/notifyOnNewEvent.ts` - New event notifications
- `functions/src/manageJoinRequest.ts` - Join approval notifications
- `functions/src/cancelEvent.ts` - Event cancellation notifications
- `functions/src/processWaitlist.ts` - Waitlist promotion notifications
- `functions/src/sendEventReminders.ts` - 24h reminder notifications
- `functions/src/cleanupInvalidTokens.ts` - Token cleanup utility

---

## Debugging Missing FCM Tokens

If you don't see `fcmTokens` field in any user documents:

### Step 1: Check App Logs

When you sign in, you should see these logs:
```
[NotificationService] FCM Token: [long-token-string]
[NotificationService] Successfully updated FCM token in Firestore.
```

If you see an error instead:
```
[NotificationService] Error updating FCM token: [error message]
```

### Step 2: Verify FCM Token Registration

**Note:** As of 2025-10-13, FCM tokens are written directly to Firestore from the client (not via Cloud Function) to avoid authentication issues on emulators and ensure reliable token registration.

### Step 3: Common Fixes

1. **FCM Token not appearing in Firestore:**
   - Check app logs for "Successfully updated FCM token"
   - Verify Firestore Security Rules allow users to update their `fcmTokens` field
   - Try signing out and back in

2. **User document doesn't exist:**
   - Sign in to the app (triggers user document creation)
   - Or manually create user document in Firestore

3. **Permission issues:**
   - Check Firestore Security Rules allow authenticated users to read/write their own user document
   - Rule should allow updates to: `fcmTokens`, `displayName`, `photoURL`, `notificationsEnabled`

4. **iOS-specific: No permission granted:**
   - Settings → GetSpot → Notifications → Allow Notifications (ON)
   - Reinstall app to retrigger permission prompt

5. **Stale app installation:**
   - Clear app data (or uninstall/reinstall)
   - Sign in again to trigger fresh FCM token registration

---

## Next Steps

If notifications still aren't working after following this guide:

1. Check app logs for errors
2. Check Firebase Console → Functions logs
3. Verify FCM token exists in Firestore (use debugging steps above)
4. Test with Firebase Console's "Send test message" feature
5. Try reinstalling the app to regenerate FCM token
6. Check that latest functions are deployed: `firebase deploy --only functions`
